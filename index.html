<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>КТ №7 — FileReader API</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;max-width:980px;margin:18px auto;padding:0 12px}
    .box{border:1px solid #ddd;border-radius:10px;padding:12px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
    button,input,select{padding:8px 10px}
    .muted{color:#666;font-size:12px}
    .list{margin-top:10px}
    .item{padding:8px 0;border-bottom:1px solid #eee}
    .name{font-weight:600}
    a{cursor:pointer}
    dialog{border:1px solid #ddd;border-radius:10px;padding:12px;max-width:900px;width:92%}
    pre{white-space:pre-wrap;word-break:break-word;background:#f6f6f6;padding:10px;border-radius:8px;max-height:55vh;overflow:auto}
    img,video,audio{max-width:100%}
  </style>
</head>
<body>
  <h3>FileReader API локальная галерея</h3>

  <div class="box">
    <div class="row">
      <input id="fileInput" type="file" multiple />
      <button onclick="resetFiles()">Сбросить</button>
    </div>

    <div class="row">
      <select id="typeFilter">
        <option value="all">Фильтр по типу: все</option>
      </select>

      <input id="sizeFilter" type="number" min="0" step="1" placeholder="Фильтр по размеру (байт)" style="width:220px" />
      <button onclick="applyFilters()">Применить</button>
      <span class="muted" id="stat"></span>
    </div>

    <div class="muted">Сохраняется в localStorage (dataURL/base64). Если файл слишком большой — будет сообщение.</div>
    <div class="list" id="list"></div>
  </div>

  <dialog id="viewer">
    <div class="row" style="justify-content:space-between">
      <div class="muted" id="viewerTitle"></div>
      <button onclick="closeViewer()">Закрыть</button>
    </div>
    <div id="viewerBody"></div>
  </dialog>

  <script>
    const LS_KEY = "kt7_files_v1";

    const fileInput = document.getElementById("fileInput");
    const typeFilter = document.getElementById("typeFilter");
    const sizeFilter = document.getElementById("sizeFilter");
    const list = document.getElementById("list");
    const stat = document.getElementById("stat");

    const viewer = document.getElementById("viewer");
    const viewerTitle = document.getElementById("viewerTitle");
    const viewerBody = document.getElementById("viewerBody");

    let files = loadLS();

    fileInput.addEventListener("change", async () => {
      const picked = Array.from(fileInput.files || []);
      if (picked.length === 0) return;

      for (const f of picked) {
        try {
          const dataUrl = await readAsDataURL(f);
          const rec = {
            id: cryptoId(),
            name: f.name,
            type: f.type || "application/octet-stream",
            size: f.size,
            dataUrl,
            addedAt: Date.now()
          };
          files.unshift(rec);
          saveLS(files);
        } catch (e) {
          alert("Не удалось сохранить файл: " + f.name);
        }
      }

      fileInput.value = "";
      refreshTypeFilter();
      render();
    });

    function readAsDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(r.error || new Error("FileReader error"));
        r.readAsDataURL(file);
      });
    }

    function loadLS(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch { return []; }
    }

    function saveLS(arr){
      try {
        localStorage.setItem(LS_KEY, JSON.stringify(arr));
      } catch (e) {
        alert("localStorage переполнен. Удали часть файлов или добавляй файлы поменьше.");
        files = loadLS();
      }
    }

    function cryptoId(){
      if (crypto && crypto.randomUUID) return crypto.randomUUID();
      return "id_" + Math.random().toString(16).slice(2) + Date.now();
    }

    function resetFiles(){
      if (!confirm("Удалить все сохранённые файлы из localStorage?")) return;
      localStorage.removeItem(LS_KEY);
      files = [];
      refreshTypeFilter();
      render();
    }

    function refreshTypeFilter(){
      const current = typeFilter.value || "all";
      const types = Array.from(new Set(files.map(f => f.type))).sort();

      typeFilter.innerHTML = `<option value="all">Фильтр по типу: все</option>`;
      for (const t of types) {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        typeFilter.appendChild(opt);
      }

      if ([...typeFilter.options].some(o => o.value === current)) {
        typeFilter.value = current;
      }
    }

    function applyFilters(){
      render();
    }

    function render(){
      const t = typeFilter.value;
      const maxSize = Number(sizeFilter.value || 0);

      const filtered = files.filter(f => {
        if (t !== "all" && f.type !== t) return false;
        if (maxSize > 0 && f.size > maxSize) return false;
        return true;
      });

      stat.textContent = `Показано: ${filtered.length} / Всего: ${files.length}`;

      list.innerHTML = "";
      if (filtered.length === 0) {
        const div = document.createElement("div");
        div.className = "muted";
        div.textContent = "Нет файлов по текущему фильтру.";
        list.appendChild(div);
        return;
      }

      for (const f of filtered) {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <span class="name">${escapeHTML(f.name)}</span>
          <span class="muted"> (${escapeHTML(f.type)}, ${f.size} байт)</span>
          <a style="margin-left:8px" onclick="viewFile('${escapeQuotes(f.id)}')">Просмотр</a>
          <a style="margin-left:8px" onclick="removeFile('${escapeQuotes(f.id)}')">Удалить</a>
        `;
        list.appendChild(div);
      }
    }

    function removeFile(id){
      files = files.filter(x => x.id !== id);
      saveLS(files);
      refreshTypeFilter();
      render();
    }

    function viewFile(id){
      const f = files.find(x => x.id === id);
      if (!f) return;

      viewerTitle.textContent = `${f.name} • ${f.type} • ${f.size} байт`;
      viewerBody.innerHTML = "";

      if (f.type.startsWith("image/")) {
        const img = document.createElement("img");
        img.src = f.dataUrl;
        viewerBody.appendChild(img);
      } else if (f.type.startsWith("video/")) {
        const v = document.createElement("video");
        v.src = f.dataUrl;
        v.controls = true;
        viewerBody.appendChild(v);
      } else if (f.type.startsWith("audio/")) {
        const a = document.createElement("audio");
        a.src = f.dataUrl;
        a.controls = true;
        viewerBody.appendChild(a);
      } else if (f.type.startsWith("text/") || f.type.includes("json") || f.type.includes("xml")) {
        const pre = document.createElement("pre");
        pre.textContent = "(загрузка текста...)";
        viewerBody.appendChild(pre);
        fetch(f.dataUrl)
          .then(r => r.text())
          .then(txt => pre.textContent = txt)
          .catch(() => pre.textContent = "Не удалось прочитать как текст");
      } else {
        const a = document.createElement("a");
        a.href = f.dataUrl;
        a.download = f.name;
        a.textContent = "Скачать файл";
        viewerBody.appendChild(a);
      }

      viewer.showModal();
    }

    function closeViewer(){
      viewer.close();
    }

    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function escapeQuotes(s){
      return String(s).replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/'/g,"\\'");
    }

    refreshTypeFilter();
    render();
  </script>
</body>

</html>
